# An Example of How to Encrypt Your Log Messages

This guide walks you through how to encrypt log messages generated by your container workloads running on **IBM Cloud Hyper Protect Virtual Server for VPC (HPVS)** and **Hyper Protect Container Runtime for Red Hat Virtualization Solutions (HPCR RHVS)**.

The virtual server instance is created using an [IBM Hyper Protect Container Runtime (HPCR) image](https://cloud.ibm.com/docs/vpc?topic=vpc-vsabout-images#hyper-protect-runtime).


## Background

**Hyper Protect Virtual Servers for VPC** and **Hyper Protect Container Runtime for Red Hat Virtualization Solutions (HPCR RHVS)** are built on a newly introduced [encrypted contract](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se) concept. A valid contract is required to create an instance. Part of this contract includes your logging configuration — you can learn more about that [here](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc).

Logs generated by your deployed workloads are securely transmitted over TLS to the [IBM Cloud Logs instance](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc) you provisioned, and are displayed on the IBM Cloud Logs (ICL) dashboard.

Although the data is encrypted in transit, logs appear as plain text on the IBM Cloud logs dashboard. If your containerized workloads generate sensitive information, this tutorial shows you how to configure your setup so that selected log messages appear as **ciphertext** on the dashboard.

To view the original message content, you can download the logs from your IBM Cloud Logs instance and decrypt them by following the steps provided in this tutorial.


## Introduction

### Prerequisite

1. **Install [OpenSSL](https://www.openssl.org/):**  
   Ensure you have OpenSSL version 3.0 or later installed, as this tutorial relies on features introduced in that version.

2. **Set Up Your Logging Instance:**  
   Follow the official [IBM Cloud guide](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc) to configure your logging instance.

3. **Linux Environment:**  
   The example provided in this tutorial is designed to run on a Linux-based system.

### About the Contract and Public Key Setup

The [contract](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se) is a YAML file used to define the configuration for creating **Hyper Protect Virtual Servers for VPC** and **Hyper Protect Container Runtime for Red Hat Virtualization Solutions (HPCR RHVS)** instances.

In this tutorial, a dedicated public/private key pair is used to encrypt and decrypt selected log messages:

- The **private key** remains with you and is used to decrypt downloaded logs.
- The **public key** (`logging.pub`) must be embedded in the contract — this is a unique approach for our encryption use case.

#### Public Key Placement Based on Contract Type

- **For Docker Compose Contracts:**  
  Place the `logging.pub` file in the `compose` folder, alongside the `docker-compose.yml` file.

- **For Podman Play Contracts:**  
  Place the `logging.pub` file in the `pods` folder, alongside the `pods.yaml` file.

According to the [`workload` section](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_workload) of the contract specification, the `archive` subsection must contain a base64-encoded TGZ archive of the relevant deployment files (e.g., `docker-compose.yml` or `pods.yaml`). Since `logging.pub` is stored in the same folder, it will be included in this encoded archive and available to the virtual server instance for log encryption.

> This tutorial also provides sample files — `env.yaml`, `workload.compose.yaml`, `workload.pods.yaml`, and `user-data.yaml`. These samples are provided for reference only to help ensure your files follow the correct schema.


### Docker Compose (Supported on HPVS Only)

This section demonstrates how to deploy a Docker container on an **IBM Cloud Hyper Protect Virtual Server for VPC (HPVS)** using Docker Compose. The deployment files are organized in the `/compose` directory, which includes the following:

1. **`docker-compose.yml`**  
   Located in the `/compose` directory, this file defines the containerized application used in this tutorial. It pulls the official [Ubuntu image from Docker Hub](https://hub.docker.com/_/ubuntu).

2. **`example.sh`**  
   A shell script referenced in the Docker Compose file via the `command:` instruction. This script:
   - Prints a line of plain text
   - Prints a line of encrypted text  
   
   It is located in the `/compose/bin` directory.

3. **`logging.pub`**  
   A public key used to encrypt log messages. It must be present in the `/compose` directory.  
   This tutorial includes steps to generate a public/private key pair using `openssl`, secured with AES encryption and a passphrase.

4. **Volume Mounting**  
   The `volumes:` section in the Compose file mounts the `/compose` directory (containing the script and public key) to `/var/logging` inside the container.  
   When the Ubuntu container starts, it runs `example.sh` as its main application.


### Podman Play (Supported on Both HPVS and HPCR RHVS)

This section demonstrates how to deploy a container using **Podman Play** on both **IBM Cloud Hyper Protect Virtual Server for VPC (HPVS)** and **Hyper Protect Container Runtime for Red Hat Virtualization Solutions (HPCR RHVS)**. Deployment files are located in the `/pods` directory:

1. **`pods.yaml`**  
   Located in the `/pods` directory, this file defines the containerized application. Like the Docker example, it uses the official [Ubuntu image from Docker Hub](https://hub.docker.com/_/ubuntu).

2. **`example.sh`**  
   A shell script specified in the container’s `command:` section. This script:
   - Outputs a line of plain text
   - Outputs a line of encrypted text  
   
   It resides in the `/pods/bin` directory.

3. **`logging.pub`**  
   A public key used for log message encryption, which must be present in the `/pods` directory.  
   As with the Docker example, this tutorial provides instructions for generating the key pair using `openssl` with AES encryption and a passphrase.

4. **Volume Mounting**  
   The volume definition mounts the `/pods` directory to `/var/logging` inside the container.  
   When the container launches, it executes `example.sh` as the primary application.


## Prepare Your Contract

This tutorial will get you started with a simple Hyper Protect Virtual Servers for VPC contract that only has an [`env` section](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_env) and a [`workload` section](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_workload).
As recommended by the [product guide](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_encrypt), we will encrypt both sections. When the Hyper Protect Virtual Servers for VPC instance boots, the bootloader decrypts the contract if it is encrypted. Download the certificate that is used to encrypt the contract [here](https://cloud.ibm.com/media/docs/downloads/hyper-protect-container-runtime/ibm-hyper-protect-container-runtime-1-0-s390x-8-encrypt.crt). By the time this tutorial was written, the latest version of the IBM Hyper Protect Container Runtime image version was `ibm-hyper-protect-container-runtime-1-0-s390x-8`, thus this example uses the certificate for this image. The file `hpcr.crt` is already available inside `example-files`. Please follow the steps below to obtain the simple contract.
1. Get the hostname and the ingestion key of your logging instance, see [Logging for Hyper Protect Virtual Servers for VPC](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc).
2. Create and encrypt the `env` section. Please refer to the `env.yaml` file in the `example-files` folder, replace the content with your logging hostname and ingestion key. Run the `encrypt-basic.sh` script to obtain the encrypted `env` section of the contract.
```
        cat env.yaml | ./encrypt-basic.sh hpcr.crt
```
3. Create the `workload` section. Please refer to the `workload.yaml` sample file in the `example-files` folder. In this example, the docker compose file in the `example-files` folder will be used for the `compose` subsection.
***In addition, please provide the public key for encrypting the log messages.***
Run the following commands to generate a key pair, we will proceed with the public key ( please note that `logEncrypt` is the passphrase to generate keys, you may use your own).
```
        openssl genrsa -aes128 -passout pass:logEncrypt -out logging 4096
```
```
        openssl rsa -in logging -passin pass:logEncrypt -pubout -out logging.pub
```
4. A sample output can be found in the `compose` folder under `example-files`. Keep in mind that the `logging.pub` file containing the public key must lie within the `compose` folder along with `docker-compose.yml`.

We then go on the compress and encrypt the folder, as the `compose` subsection requires this for the `archive` value. Use the followin command to obtain the `base64` encoded archive as a file named `compose.b64`. Use the raw content of `compose.b64` for the value of `archive` under the `compose` subsection.
```
        tar czvf - -C <COMPOSE_FOLDER> . | base64 -w0 > compose.b64
```
5. Run the `encrypt-basic.sh` script to obtain the encrypted `workload` section of the contract.
```
        cat workload.yaml | ./encrypt-basic.sh hpcr.crt
```
6. Complete the `user-data.yaml` with the output of of Step 2 and 5. Please refer to the sample `user-data.yaml` for correct schema. Please note the `hyper-protect-basic` token approach to implement hybrid encryption, as it is used throughout **IBM Cloud Hyper Protect Virtual Server for VPC**


## Create your Virtual Server Instance

With the User Data available, we go ahead to create an instance. The quickest way is to use the [UI](https://cloud.ibm.com/docs/vpc?topic=vpc-creating-virtual-servers&interface=ui). For the Operating system, choose [**IBM Hyper Protect**](https://cloud.ibm.com/docs/vpc?topic=vpc-vsabout-images#hyper-protect-runtime) to create an **IBM Cloud® Hyper Protect Virtual Server for IBM Cloud® Virtual Private Cloud instance**. Remember to paste your User Data in the `User data` box. Click **Create virtual server instance** when you are ready. Next, monitor the Serial Console, go to the logging instance you provisioned when the VSI is up and running. Open the Dash Board and find the cipher text which is your encrypted log message.

Use the `decrypt-basic.sh` along with the private key you generated to decipher the encrypted log message.
```
echo hyper-protect-basic.rdf...EqM | decrypt-basic.sh logging
```
