# An Example of How to Encrypt Your Log Messages

This guide walks you through how to encrypt log messages generated by your container workloads running on **IBM Cloud Hyper Protect Virtual Server for VPC (HPVS)** and **Hyper Protect Container Runtime for Red Hat Virtualization Solutions (HPCR RHVS)**.

The virtual server instance is created using an [IBM Hyper Protect Container Runtime (HPCR) image](https://cloud.ibm.com/docs/vpc?topic=vpc-vsabout-images#hyper-protect-runtime).


## Background

**Hyper Protect Virtual Servers for VPC** and **Hyper Protect Container Runtime for Red Hat Virtualization Solutions (HPCR RHVS)** are built on a newly introduced [encrypted contract](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se) concept. A valid contract is required to create an instance. Part of this contract includes your logging configuration — you can learn more about that [here](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc).

Logs generated by your deployed workloads are securely transmitted over TLS to the [IBM Cloud Logs instance](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc) you provisioned, and are displayed on the IBM Cloud Logs (ICL) dashboard.

Although the data is encrypted in transit, logs appear as plain text on the IBM Cloud logs dashboard. If your containerized workloads generate sensitive information, this tutorial shows you how to configure your setup so that selected log messages appear as **ciphertext** on the dashboard.

To view the original message content, you can download the logs from your IBM Cloud Logs instance and decrypt them by following the steps provided in this tutorial.


## Introduction

### Prerequisite

1. **Install [OpenSSL](https://www.openssl.org/):**  
   Ensure you have OpenSSL version 3.0 or later installed, as this tutorial relies on features introduced in that version.

2. **Set Up Your Logging Instance:**  
   Follow the official [IBM Cloud guide](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc) to configure your logging instance.

3. **Linux Environment:**  
   The example provided in this tutorial is designed to run on a Linux-based system.

### About the Contract and Public Key Setup

The [contract](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se) is a YAML file used to define the configuration for creating **Hyper Protect Virtual Servers for VPC** and **Hyper Protect Container Runtime for Red Hat Virtualization Solutions (HPCR RHVS)** instances.

In this tutorial, a dedicated public/private key pair is used to encrypt and decrypt selected log messages:

- The **private key** remains with you and is used to decrypt downloaded logs.
- The **public key** (`logging.pub`) must be embedded in the contract — this is a unique approach for our encryption use case.

#### Public Key Placement Based on Contract Type

- **For Docker Compose Contracts:**  
  Place the `logging.pub` file in the `compose` folder, alongside the `docker-compose.yaml` file.

- **For Podman Play Contracts:**  
  Place the `logging.pub` file in the `pods` folder, alongside the `pods.yaml` file.

According to the [`workload` section](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_workload) of the contract specification, the `archive` subsection must contain a base64-encoded TGZ archive of the relevant deployment files (e.g., `docker-compose.yaml` or `pods.yaml`). Since `logging.pub` is stored in the same folder, it will be included in this encoded archive and available to the virtual server instance for log encryption.

> This tutorial also provides sample files — `env.yaml`, `workload.compose.yaml`, `workload.pods.yaml`, and `user-data.yaml`. These samples are provided for reference only to help ensure your files follow the correct schema.


### Docker Compose (Supported on HPVS Only)

This section demonstrates how to deploy a Docker container on an **IBM Cloud Hyper Protect Virtual Server for VPC (HPVS)** using Docker Compose. The deployment files are organized in the `/compose` directory, which includes the following:

1. **`docker-compose.yaml`**  
   Located in the `/compose` directory, this file defines the containerized application used in this tutorial. It pulls the official [Ubuntu image from Docker Hub](https://hub.docker.com/_/ubuntu).

2. **`example.sh`**  
   A shell script referenced in the Docker Compose file via the `command:` instruction. This script:
   - Prints a line of plain text
   - Prints a line of encrypted text  
   
   It is located in the `/compose/bin` directory.

3. **`logging.pub`**  
   A public key used to encrypt log messages. It must be present in the `/compose` directory.  
   This tutorial includes steps to generate a public/private key pair using `openssl`, secured with AES encryption and a passphrase.

4. **Volume Mounting**  
   The `volumes:` section in the Compose file mounts the `/compose` directory (containing the script and public key) to `/var/logging` inside the container.  
   When the Ubuntu container starts, it runs `example.sh` as its main application.


### Podman Play (Supported on Both HPVS and HPCR RHVS)

This section demonstrates how to deploy a container using **Podman Play** on both **IBM Cloud Hyper Protect Virtual Server for VPC (HPVS)** and **Hyper Protect Container Runtime for Red Hat Virtualization Solutions (HPCR RHVS)**. Deployment files are located in the `/pods` directory:

1. **`pods.yaml`**  
   Located in the `/pods` directory, this file defines the containerized application. Like the Docker example, it uses the official [Ubuntu image from Docker Hub](https://hub.docker.com/_/ubuntu).

2. **`example.sh`**  
   A shell script specified in the container’s `command:` section. This script:
   - Outputs a line of plain text
   - Outputs a line of encrypted text  
   
   It resides in the `/pods/bin` directory.

3. **`logging.pub`**  
   A public key used for log message encryption, which must be present in the `/pods` directory.  
   As with the Docker example, this tutorial provides instructions for generating the key pair using `openssl` with AES encryption and a passphrase.

4. **Volume Mounting**  
   The volume definition mounts the `/pods` directory to `/var/logging` inside the container.  
   When the container launches, it executes `example.sh` as the primary application.


## Prepare Your Contract

This tutorial will guide you through creating a simple contract for both **IBM Cloud Hyper Protect Virtual Server for VPC (HPVS)** and **Hyper Protect Container Runtime for Red Hat Virtualization Solutions (HPCR RHVS)**. The contract consists of just two sections:

- An [`env` section](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_env)  
- A [`workload` section](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_workload)

As recommended by the [product guide](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_encrypt), both sections should be encrypted. When your HPVS or HPCR RHVS instance boots, the bootloader decrypts the contract automatically if it’s encrypted.

You will need to download the certificate used for contract encryption. Follow the instructions here: [Downloading the encryption certificate and extracting the public key](https://cloud.ibm.com/docs/vpc?topic=vpc-about-contract_se#hpcr_contract_encrypt).  

For this example, we assume you’ve downloaded the latest encryption certificate and renamed it to `hpcr.crt`.


### Steps to Create Your Contract


#### 1. Get Logging Instance Details

Get the **hostname** and **IAM API Key** of your logging instance. For help, see [Logging for Hyper Protect Virtual Servers for VPC](https://cloud.ibm.com/docs/vpc?topic=vpc-logging-for-hyper-protect-virtual-servers-for-vpc).


#### 2. Create and Encrypt the `env` Section

- Edit the `env.yaml` file in this folder: replace its content with your logging hostname and IAM key.
- Run this command to encrypt the `env` section:

```bash
cat env.yaml | ./encrypt-basic.sh hpcr.crt
```

This will output your encrypted `env` section.


#### 3. Create the workload Section

You have two options to define the workload section:

- Use `workload.compose.yaml` to create a Docker Compose contract.
- Use `workload.pods.yaml` to create a Podman Play contract.

Both files are included in this folder and correspond to the `compose` and `play` subsections, respectively.


#### Important: Generate a Public Key for Log Message Encryption

You must provide a public key to encrypt your log messages. Generate the key pair with the following commands (replace the passphrase `logEncrypt` if you want):

```bash
openssl genrsa -aes128 -passout pass:logEncrypt -out logging 4096
openssl rsa -in logging -passin pass:logEncrypt -pubout -out logging.pub
```

- `logging` is your encrypted private key file.  
- `logging.pub` is the public key file.

Make sure to place the `logging.pub` file inside your `compose` or `pods` folder alongside your `docker-compose.yaml` or `pods.yaml` respectively.


#### 4. Compress and Encode the Workload Folder

For the Docker Compose workload, compress and encode the folder as base64. This is required for the `archive` field under the `compose` subsection.

Run this command:

```bash
tar czvf compose.tgz compose/bin compose/docker-compose.yaml compose/logging.pub
base64 -w0 compose.tgz > compose.b64
```

For the Podman Play workload, compress and encode the folder as base64. This is required for the `archive` field under the `play` subsection.

Run this command:

```bash
tar czvf pods.tgz pods/bin pods/pods.yaml pods/logging.pub
base64 -w0 pods.tgz > pods.b64
```

Use the raw content of `compose.b64` or `pods.b64` as the value for the archive field.


#### 5. Encrypt the workload Section

Run the encryption script on your workload file:

```bash
cat workload.yaml | ./encrypt-basic.sh hpcr.crt
```

This will output the encrypted workload section.


#### 6. Complete the `user-data.yaml`

Use the encrypted outputs from Step 2 (`env`) and Step 5 (`workload`) to complete your `user-data.yaml`. Refer to the sample `user-data.yaml` for the correct structure and schema.

> **Note:** The `hyper-protect-basic` token approach is used here to implement hybrid encryption, which is consistent across both **IBM Cloud Hyper Protect Virtual Server for VPC** and **Hyper Protect Container Runtime for RedHat Virtualization Solutions**.


## Example: Generate Encrypted Logs on your IBM Hyper Protect Virtual Servers Instance in IBM Cloud

With the User Data available, you can now create an instance. The quickest way is to use the [UI](https://cloud.ibm.com/docs/vpc?topic=vpc-creating-virtual-servers&interface=ui).

For the Operating System, choose [**IBM Hyper Protect**](https://cloud.ibm.com/docs/vpc?topic=vpc-vsabout-images#hyper-protect-runtime) to create an **IBM Cloud Hyper Protect Virtual Server for VPC**.

Remember to paste your User Data in the `User data` box. Click **Create virtual server instance** when you are ready.

Next, monitor the Serial Console. Once the VSI is up and running, go to the logging instance you provisioned. Open the Dashboard and locate the cipher text, which is your encrypted log message.

Use the `decrypt-basic.sh` script along with the private key you generated to decipher the encrypted log message:

```bash
echo hyper-protect-basic.rdf...EqM | ./decrypt-basic.sh logging
```
